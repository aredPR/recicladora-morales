{% extends "base.html" %}
{% block title %}Ventas - Recicladora{% endblock %}

{% block content %}
<h1 class="text-2xl font-bold mb-4">Ventas</h1>

<!-- FORMULARIO DE ALTA -->
<div class="bg-white shadow rounded p-6 mb-6">
  <h2 class="font-semibold mb-4">Registrar venta</h2>
  <form id="form-venta" class="grid grid-cols-6 gap-4">
    <div class="col-span-2">
      <label class="block text-sm">Cliente</label>
      <select id="cliente" class="border p-2 rounded w-full"></select>
    </div>
    <div class="col-span-2">
      <label class="block text-sm">Material</label>
      <select id="material" class="border p-2 rounded w-full"></select>
    </div>
    <div>
      <label class="block text-sm">Cantidad (kg)</label>
      <input type="number" step="0.01" id="cantidad_kg" class="border p-2 rounded w-full" required>
    </div>
    <div>
      <label class="block text-sm">Precio unitario ($/kg)</label>
      <input type="number" step="0.01" id="precio_unitario" class="border p-2 rounded w-full" required>
    </div>
    <div class="col-span-6 flex gap-2">
      <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded">Guardar</button>
      <span id="msg-venta" class="text-sm"></span>
    </div>
  </form>
</div>

<!-- FILTROS -->
<form id="filtros-v" class="bg-white shadow rounded p-4 mb-4 grid grid-cols-6 gap-4">
  <div>
    <label class="block text-sm">Fecha inicio</label>
    <input type="datetime-local" id="vf_ini" class="border p-2 rounded w-full">
  </div>
  <div>
    <label class="block text-sm">Fecha fin</label>
    <input type="datetime-local" id="vf_fin" class="border p-2 rounded w-full">
  </div>
  <div>
    <label class="block text-sm">Cliente (ID)</label>
    <input type="number" id="vf_cli" class="border p-2 rounded w-full" placeholder="Opcional">
  </div>
  <div>
    <label class="block text-sm">Material (ID)</label>
    <input type="number" id="vf_mat" class="border p-2 rounded w-full" placeholder="Opcional">
  </div>
  <div>
    <label class="block text-sm">Ordenar por</label>
    <select id="vf_order" class="border p-2 rounded w-full">
      <option value="-fecha">Fecha (desc)</option>
      <option value="fecha">Fecha (asc)</option>
      <option value="-total">Total (desc)</option>
      <option value="total">Total (asc)</option>
      <option value="-cantidad_kg">Kg (desc)</option>
      <option value="cantidad_kg">Kg (asc)</option>
    </select>
  </div>
  <div class="flex items-end gap-2">
    <button id="btn-filtrar-v" class="px-4 py-2 bg-gray-800 text-white rounded" type="submit">Aplicar</button>
    <button id="btn-limpiar-v" class="px-4 py-2 border rounded" type="button">Limpiar</button>
  </div>
</form>

<!-- Paginación -->
<div id="pager-v" class="flex items-center gap-2 mb-2">
  <button id="prev-v" class="px-3 py-1 border rounded">« Anterior</button>
  <button id="next-v" class="px-3 py-1 border rounded">Siguiente »</button>
  <span id="meta-v" class="text-sm text-gray-600 ml-2"></span>
</div>

<!-- TABLA -->
<div class="bg-white shadow rounded p-4">
  <div class="flex items-center justify-between mb-4">
    <h2 class="font-semibold">Ventas registradas</h2>
    <button id="btn-recargar-v" class="px-3 py-1 rounded border">Recargar</button>
  </div>
  <div class="overflow-x-auto">
    <table class="w-full text-left">
      <thead>
        <tr class="border-b">
          <th class="py-2 px-2">ID</th>
          <th class="py-2 px-2">Cliente</th>
          <th class="py-2 px-2">Material</th>
          <th class="py-2 px-2">Kg</th>
          <th class="py-2 px-2">PU</th>
          <th class="py-2 px-2">Total</th>
          <th class="py-2 px-2">Fecha</th>
          <th class="py-2 px-2">Acciones</th>
        </tr>
      </thead>
      <tbody id="tabla-ventas"></tbody>
    </table>
  </div>
</div>

<script>
(async () => {
  // Combos
  const [clientes, materiales] = await Promise.all([
    fetch("/api/clientes/").then(r => r.json()),
    fetch("/api/materiales/").then(r => r.json()),
  ]);
  document.getElementById("cliente").innerHTML  = clientes.map(c => `<option value="${c.id}">${c.nombre}</option>`).join("");
  document.getElementById("material").innerHTML = materiales.map(m => `<option value="${m.id}">${m.nombre}</option>`).join("");

  // Estado paginación
  let paginaActualURL = "/api/ventas/?page=1";

  // Helpers
  function toISO(dtLocal) { return dtLocal ? new Date(dtLocal).toISOString() : ""; }

  function buildQueryV() {
    const params = new URLSearchParams();
    const fIni = document.getElementById("vf_ini").value;
    const fFin = document.getElementById("vf_fin").value;
    const cli  = document.getElementById("vf_cli").value;
    const mat  = document.getElementById("vf_mat").value;
    const ord  = document.getElementById("vf_order").value;

    if (fIni) params.append("fecha_min", toISO(fIni));
    if (fFin) params.append("fecha_max", toISO(fFin));
    if (cli)  params.append("cliente", cli);
    if (mat)  params.append("material", mat);
    if (ord)  params.append("ordering", ord);
    params.append("page", "1");
    return "/api/ventas/?" + params.toString();
  }

  async function cargarVentas(url = paginaActualURL) {
    const resp = await fetch(url);
    const data = await resp.json();
    const tbody = document.getElementById("tabla-ventas");

    let results = data.results || data;
    tbody.innerHTML = results.map(v => `
      <tr class="border-b" data-id="${v.id}" data-cant="${v.cantidad_kg}" data-precio="${v.precio_unitario}">
        <td class="py-2 px-2">${v.id}</td>
        <td class="py-2 px-2">${v.cliente}</td>
        <td class="py-2 px-2">${v.material}</td>
        <td class="py-2 px-2">${v.cantidad_kg}</td>
        <td class="py-2 px-2">$${Number(v.precio_unitario).toFixed(2)}</td>
        <td class="py-2 px-2 font-semibold">$${Number(v.total).toFixed(2)}</td>
        <td class="py-2 px-2">${new Date(v.fecha).toLocaleString()}</td>
        <td class="py-2 px-2 flex gap-2">
          <button class="px-3 py-1 rounded bg-blue-600 text-white btn-edit">Editar</button>
          <button class="px-3 py-1 rounded bg-red-600 text-white btn-del">Eliminar</button>
        </td>
      </tr>
    `).join("");

    // Paginación
    paginaActualURL = url;
    const prevBtn = document.getElementById("prev-v");
    const nextBtn = document.getElementById("next-v");
    prevBtn.disabled = !data.previous;
    nextBtn.disabled = !data.next;
    prevBtn.onclick = data.previous ? (() => cargarVentas(data.previous)) : null;
    nextBtn.onclick = data.next ? (() => cargarVentas(data.next)) : null;
    document.getElementById("meta-v").textContent = `Total: ${data.count ?? results.length}`;
  }

  // Inicial
  await cargarVentas();

  // Recargar
  document.getElementById("btn-recargar-v").addEventListener("click", () => cargarVentas("/api/ventas/?page=1"));

  // Filtros
  document.getElementById("btn-filtrar-v").addEventListener("click", (e) => {
    e.preventDefault();
    const url = buildQueryV();
    cargarVentas(url);
  });
  document.getElementById("btn-limpiar-v").addEventListener("click", () => {
    ["vf_ini","vf_fin","vf_cli","vf_mat"].forEach(id => document.getElementById(id).value = "");
    document.getElementById("vf_order").value = "-fecha";
    cargarVentas("/api/ventas/?page=1");
  });

  // Alta
  const $form = document.getElementById("form-venta");
  const $msg  = document.getElementById("msg-venta");
  $form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const payload = {
      cliente: Number(document.getElementById("cliente").value),
      material: Number(document.getElementById("material").value),
      cantidad_kg: document.getElementById("cantidad_kg").value,
      precio_unitario: document.getElementById("precio_unitario").value
    };
    const res = await fetch("/api/ventas/", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": CSRF_TOKEN },
      body: JSON.stringify(payload)
    });
    if (res.ok) {
      $msg.textContent = "✅ Venta registrada.";
      $msg.className = "text-green-600 text-sm";
      $form.reset();
      await cargarVentas("/api/ventas/?page=1");
    } else {
      const err = await res.json().catch(() => ({}));
      $msg.textContent = "❌ Error al registrar venta: " + (JSON.stringify(err) || res.statusText);
      $msg.className = "text-red-600 text-sm";
    }
  });

  // Editar / Eliminar
  document.getElementById("tabla-ventas").addEventListener("click", async (ev) => {
    const row = ev.target.closest("tr");
    if (!row) return;
    const id = row.dataset.id;

    if (ev.target.classList.contains("btn-del")) {
      if (!confirm("¿Eliminar venta #" + id + "?")) return;
      try { await apiDelete(`/api/ventas/${id}/`); await cargarVentas("/api/ventas/?page=1"); }
      catch (e) { alert(e.message); }
      return;
    }

    if (ev.target.classList.contains("btn-edit")) {
      const html = `
        <div class="grid grid-cols-1 gap-3">
          <label class="text-sm">Cantidad (kg)
            <input id="edit_cant" type="number" step="0.01" class="border p-2 rounded w-full" value="${row.dataset.cant}">
          </label>
          <label class="text-sm">Precio unitario ($/kg)
            <input id="edit_precio" type="number" step="0.01" class="border p-2 rounded w-full" value="${row.dataset.precio}">
          </label>
        </div>
      `;
      openModal(html, async () => {
        try {
          await apiPatch(`/api/ventas/${id}/`, {
            cantidad_kg: document.getElementById("edit_cant").value,
            precio_unitario: document.getElementById("edit_precio").value
          });
          await cargarVentas(paginaActualURL);
          return true;
        } catch(e) { alert(e.message); return false; }
      });
    }
  });
})();
</script>
{% endblock %}
